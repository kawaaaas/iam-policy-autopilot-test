# 実装計画: AWS IAM 検証環境（Standard）

## 概要

Lambda 関数が SQS メッセージを受信して DynamoDB に保存する中程度の複雑さを持つ AWS 環境を実装します。CDK v2 と TypeScript を使用し、複数サービス間の権限付与を標準的な grant メソッドで行います。

## タスク

- [x] 1. プロジェクト構造と CDK 初期設定

  - TypeScript CDK プロジェクトの初期化
  - 必要な依存関係の追加（AWS SDK v3、CDK v2、SQS、DynamoDB）
  - プロジェクトディレクトリ構造の作成
  - _要件: 6.1, 6.3_

- [x] 2. DynamoDB テーブルの作成

  - [x] 2.1 CDK で DynamoDB テーブルリソースを定義

    - パーティションキー（messageId）とソートキー（timestamp）の設定
    - オンデマンド課金モードの設定
    - 検証用の removalPolicy 設定
    - _要件: 3.1, 3.2, 3.3_

  - [ ]\* 2.2 プロパティテスト: DynamoDB スキーマ検証
    - テーブル作成とスキーマの正確性確認
    - _要件: 3.1, 3.5_

- [x] 3. SQS キューとデッドレターキューの作成

  - [x] 3.1 CDK で SQS キューリソースを定義

    - メインキューの作成
    - デッドレターキューの作成と設定
    - 可視性タイムアウトの設定
    - _要件: 2.1, 2.3, 2.4_

  - [x] 3.2 サンプルメッセージの準備
    - テスト用の SQS メッセージ形式定義
    - 複数メッセージのバッチテスト用データ
    - _要件: 6.3_

- [x] 4. Lambda 関数の実装

  - [x] 4.1 SQS イベントハンドラーの実装

    - Node.js 22.x 用の SQSEvent 処理
    - AWS SDK v3 を使用した DynamoDB PutItem 実装
    - メッセージ抽出とデータ変換ロジック
    - _要件: 1.1, 1.2, 1.3, 1.4_

  - [ ]\* 4.2 プロパティテスト: メッセージ処理の完全性

    - **プロパティ 1: メッセージ処理の完全性**
    - **検証対象: 要件 1.3, 1.4**

  - [x] 4.3 バッチメッセージ処理の実装

    - 複数メッセージの並列処理
    - 個別メッセージのエラーハンドリング
    - _要件: 1.6_

  - [ ]\* 4.4 プロパティテスト: バッチ処理の正確性

    - **プロパティ 2: バッチ処理の正確性**
    - **検証対象: 要件 1.6**

  - [x] 4.5 エラーハンドリングの実装

    - DynamoDB、SQS 関連エラーの処理
    - 部分的失敗時の適切な処理
    - ログ出力とエラーメッセージ
    - _要件: 1.5_

  - [ ]\* 4.6 プロパティテスト: エラー時のメッセージ保持
    - **プロパティ 3: エラー時のメッセージ保持**
    - **検証対象: 要件 1.5, 2.4**

- [x] 5. CDK スタックの統合

  - [x] 5.1 Lambda 関数リソースの定義

    - CDK で Lambda 関数リソース作成
    - 環境変数の設定（テーブル名等）
    - Node.js 22.x ランタイムの指定
    - _要件: 4.1, 4.4_

  - [x] 5.2 IAM 権限の設定

    - queue.grantConsumeMessages()による権限付与
    - table.grantWriteData()による権限付与
    - Lambda 実行ロールの自動生成確認
    - _要件: 4.3, 2.5, 3.4_

  - [x] 5.3 イベントソースマッピングの設定

    - SQS キューと Lambda 関数の連携設定
    - バッチサイズとバッチウィンドウの設定
    - _要件: 4.5_

  - [ ]\* 5.4 プロパティテスト: 権限の適切性
    - **プロパティ 4: 権限の適切性**
    - **検証対象: 要件 2.5, 4.2, 4.3**

- [x] 6. チェックポイント - 統合動作確認

  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 7. デプロイとテスト

  - [ ] 7.1 CDK スタックのデプロイ

    - cdk deploy コマンドで AWS にデプロイ
    - 全リソース作成の確認
    - _要件: 4.6_

  - [ ] 7.2 SQS→Lambda→DynamoDB 統合テスト

    - SQS にテストメッセージ送信
    - Lambda 関数の自動実行確認
    - DynamoDB へのデータ保存確認
    - _要件: 5.3, 5.4_

  - [ ]\* 7.3 エラーケースと DLQ テスト
    - 意図的なエラー発生による DLQ 動作確認
    - 部分的失敗時の動作確認
    - _要件: 5.1, 5.2_

- [ ] 8. ドキュメントとクリーンアップ

  - [ ] 8.1 README.md の作成

    - デプロイ手順とテスト方法の記述
    - SQS メッセージ送信方法の説明
    - _要件: 6.4_

  - [ ] 8.2 クリーンアップ手順の確認
    - cdk destroy でリソース削除確認
    - DynamoDB データと SQS メッセージの削除確認
    - _要件: 6.4_

## 注意事項

- `*`マークのタスクはオプションで、コア機能を優先して MVP を早く作成できます
- 各タスクは特定の要件への追跡可能性のため要件番号を参照しています
- チェックポイントで段階的な検証を行います
- プロパティテストは汎用的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
- Simple 環境とは別のディレクトリ構造で実装します
