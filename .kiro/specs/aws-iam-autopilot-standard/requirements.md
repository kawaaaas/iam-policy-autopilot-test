# 要件定義書 - AWS IAM 検証環境（Standard）

## 概要

中程度の複雑さを持つ AWS 環境を構築します。複数サービス（Lambda → DynamoDB + SQS）の連携により、より複雑な権限付与パターンを実装し、動作確認を行います。**全てのコンポーネントは再利用可能なコンストラクトとして分割実装し、スタックは軽量に保ちます。**

## 用語集

- **Lambda 関数**: AWS Lambda 関数（Node.js 20.x or 22.x）
- **DynamoDB テーブル**: AWS DynamoDB テーブル（メッセージ保存用）
- **SQS キュー**: AWS SQS キュー（メッセージ受信用）
- **CDK スタック**: AWS CDK v2 によるインフラ定義
- **Grant メソッド**: CDK の標準的な権限付与メソッド
- **SQS_Queue_Construct**: SQS キューとその設定を管理する再利用可能なコンストラクト
- **DynamoDB_Table_Construct**: DynamoDB テーブルとその設定を管理する再利用可能なコンストラクト
- **Lambda_Function_Construct**: Lambda 関数とその設定を管理する再利用可能なコンストラクト
- **IAM_Permission_Construct**: IAM 権限の設定を管理する再利用可能なコンストラクト
- **Event_Source_Construct**: SQS と Lambda 間のイベントソースマッピングを管理するコンストラクト

## 要件

### 要件 1: Lambda 関数の実装

**ユーザーストーリー:** 開発者として、SQS メッセージを処理して DynamoDB に保存する Lambda 関数を作成したい。複数サービス連携の IAM 権限動作を確認するため。

#### 受け入れ基準

1. Lambda 関数は Node.js 20.x または 22.x ランタイムを使用する
2. Lambda 関数は AWS SDK v3 を使用して DynamoDB と SQS 操作を行う
3. Lambda 関数が SQS イベントを受信したとき、メッセージ内容を抽出する
4. メッセージ内容が抽出されたとき、PutItem を使用して DynamoDB テーブルに保存する
5. Lambda 関数はエラーを適切に処理し、適切なエラーメッセージをログに記録する
6. Lambda 関数は 1 回の呼び出しで複数メッセージが存在する場合も処理する

### 要件 2: SQS キューの設定

**ユーザーストーリー:** 開発者として、イベントソースとして SQS キューを設定したい。Lambda 関数が受信メッセージによってトリガーされるようにするため。

#### 受け入れ基準

1. SQS キューは AWS CDK v2 を使用して作成される
2. SQS キューは Lambda 関数のイベントソースとして設定される
3. SQS キューは適切な可視性タイムアウト設定を持つ
4. SQS キューはエラー処理用のデッドレターキュー設定を持つ
5. Lambda 関数は SQS キューからメッセージを受信・削除する権限を持つ

### 要件 3: DynamoDB テーブルの設定

**ユーザーストーリー:** 開発者として、メッセージ保存用の DynamoDB テーブルを設定したい。処理された SQS メッセージを永続化するため。

#### 受け入れ基準

1. DynamoDB テーブルは AWS CDK v2 を使用して作成される
2. DynamoDB テーブルはメッセージ識別用のパーティションキーを持つ
3. DynamoDB テーブルはコスト効率のためオンデマンド課金モードを使用する
4. Lambda 関数は DynamoDB テーブルにアイテムを書き込む権限を持つ
5. DynamoDB テーブルはメッセージメタデータ用の適切な属性を含む

### 要件 4: CDK インフラ定義

**ユーザーストーリー:** 開発者として、TypeScript で CDK を使用してインフラを定義したい。複数サービス環境を一貫してデプロイ・管理するため。

#### 受け入れ基準

1. CDK スタックは TypeScript で実装される
2. CDK スタックは AWS CDK v2 を使用する
3. CDK スタックは DynamoDB と SQS 権限に Grant メソッドを使用する
4. CDK スタックは Lambda 関数、DynamoDB テーブル、SQS キューリソースを作成する
5. CDK スタックは SQS と Lambda 間のイベントソースマッピングを設定する
6. CDK スタックは任意の AWS リージョンにデプロイ可能である

### 要件 5: 動作確認

**ユーザーストーリー:** 開発者として、CDK 生成の権限で正常に動作することを確認したい。複数サービス連携が正しく機能することを保証するため。

#### 受け入れ基準

1. Lambda 関数には DynamoDB と SQS 両方の AWS SDK v3 具体的呼び出しが含まれる
2. CDK スタックは標準の grant メソッドを使用して IAM ポリシーを生成する
3. 生成されたポリシーは DynamoDB PutItem と SQS メッセージ処理権限の両方をカバーする
4. Lambda 関数は CDK 生成の権限で正常に実行される
5. ポリシーの複雑さは Simple 環境より測定可能な程度高い

### 要件 6: プロジェクト構成

**ユーザーストーリー:** 開発者として、整理されたプロジェクト構成を持ちたい。複数サービス検証環境を簡単に保守・拡張するため。

#### 受け入れ基準

1. プロジェクトは Simple 環境とは別の明確なディレクトリ構造を持つ
2. Lambda 関数のコードは複数サービス統合パターンを実証する
3. プロジェクトにはテスト用のサンプル SQS メッセージが含まれる
4. プロジェクトにはデプロイとテストの手順が含まれる

### 要件 7: コンストラクト分割アーキテクチャ

**ユーザーストーリー:** 開発者として、各コンポーネントを再利用可能なコンストラクトとして実装したい。他のプロジェクトでも同じコンポーネントを使用できるようにするため。

#### 受け入れ基準

1. WHEN SQS キューが必要な場合、THE SQS_Queue_Construct SHALL 独立して動作し、設定可能な SQS キューと DLQ を作成する
2. WHEN DynamoDB テーブルが必要な場合、THE DynamoDB_Table_Construct SHALL 独立して動作し、設定可能な DynamoDB テーブルを作成する
3. WHEN Lambda 関数が必要な場合、THE Lambda_Function_Construct SHALL 独立して動作し、設定可能な Lambda 関数を作成する
4. WHEN イベントソースマッピングが必要な場合、THE Event_Source_Construct SHALL SQS と Lambda 間の接続を管理する
5. WHEN IAM 権限設定が必要な場合、THE IAM_Permission_Construct SHALL 最小権限の原則に従って複数サービスの権限を付与する

### 要件 8: スタック軽量化

**ユーザーストーリー:** 開発者として、スタックを軽量に保ちたい。スタックはコンストラクトの組み合わせのみを行い、具体的なリソース設定は各コンストラクトに委譲するため。

#### 受け入れ基準

1. WHEN スタックを定義する場合、THE Stack SHALL 各コンストラクトのインスタンス化と接続のみを行う
2. WHEN スタックを定義する場合、THE Stack SHALL 具体的な AWS リソースの設定を含まない
3. THE Stack SHALL 各コンストラクト間の依存関係を明確に管理する
4. THE Stack SHALL 必要な出力値を外部に公開する
