# 要件定義書 - AWS IAM 検証環境（Complex）

## 概要

最も複雑な AWS 環境を構築します。高度な依存関係とセキュアな AI 処理（Lambda → Bedrock + S3 + Secrets Manager + EventBridge + KMS）により、最も複雑な権限付与パターンを実装し、動作確認を行います。**全てのコンポーネントは再利用可能なコンストラクトとして分割実装し、スタックは軽量に保ちます。**

## 用語集

- **Lambda 関数**: AWS Lambda 関数（Node.js 20.x or 22.x）
- **Bedrock サービス**: AWS Bedrock（AI/ML サービス）
- **S3 バケット**: AWS S3 バケット（KMS 暗号化済み）
- **Secrets Manager**: AWS Secrets Manager（外部 Webhook URL 格納）
- **EventBridge バス**: カスタム EventBridge イベントバス
- **KMS キー**: AWS KMS カスタマーマネージドキー
- **CDK スタック**: AWS CDK v2 によるインフラ定義
- **KMS_Key_Construct**: KMS キーとその設定を管理する再利用可能なコンストラクト
- **S3_Storage_Construct**: KMS 暗号化 S3 バケットとその設定を管理する再利用可能なコンストラクト
- **Secrets_Manager_Construct**: Secrets Manager とその設定を管理する再利用可能なコンストラクト
- **EventBridge_Construct**: EventBridge カスタムバスとその設定を管理する再利用可能なコンストラクト
- **Lambda_Function_Construct**: Lambda 関数とその設定を管理する再利用可能なコンストラクト
- **IAM_Permission_Construct**: 複雑な IAM 権限の設定を管理する再利用可能なコンストラクト

## 要件

### 要件 1: Bedrock 統合 Lambda 関数

**ユーザーストーリー:** 開発者として、Bedrock で AI 処理を行う Lambda 関数を作成したい。AI サービスを含む複雑な IAM 権限生成をテストするため。

#### 受け入れ基準

1. Lambda 関数は Node.js 20.x または 22.x ランタイムを使用する
2. Lambda 関数はすべてのサービス操作に AWS SDK v3 を使用する
3. Lambda 関数はテキスト処理のため Bedrock モデルを呼び出す
4. Bedrock 処理が完了したとき、Lambda 関数は結果を S3 バケットに保存する
5. Lambda 関数は Bedrock のスロットリングとエラーレスポンスを適切に処理する

### 要件 2: KMS 暗号化 S3 ストレージ

**ユーザーストーリー:** 開発者として、KMS 暗号化された S3 ストレージを使用したい。暗号化キー依存関係を持つ IAM ポリシーをテストするため。

#### 受け入れ基準

1. S3 バケットはカスタマーマネージド KMS キーで暗号化される
2. KMS キーは S3 暗号化専用に CDK を使用して作成される
3. Lambda 関数は S3 操作を通じて暗黙的な KMS 権限を持つ
4. Lambda 関数が S3 バケットに書き込むとき、操作は KMS 暗号化を使用する
5. Lambda 関数が S3 バケットから読み込むとき、操作は KMS キーを使用して復号化する

### 要件 3: Secrets Manager 統合

**ユーザーストーリー:** 開発者として、Secrets Manager からシークレットを取得したい。シークレットアクセスパターンを持つ IAM ポリシーをテストするため。

#### 受け入れ基準

1. Secrets Manager はダミーの外部 webhook URL を保存する
2. Secrets Manager のシークレットは別の KMS キーで暗号化される
3. Lambda 関数は GetSecretValue を使用してシークレットを取得する
4. Lambda 関数は取得した webhook URL を処理ロジックで使用する
5. シークレット用の KMS キーは S3 用の KMS キーとは別である

### 要件 4: EventBridge カスタムバス

**ユーザーストーリー:** 開発者として、カスタム EventBridge バスにイベントを送信したい。イベント発行パターンを持つ IAM ポリシーをテストするため。

#### 受け入れ基準

1. EventBridge バスは CDK で作成されるカスタムイベントバスである
2. Lambda 関数は PutEvents 操作を使用してイベントを送信する
3. イベントは処理結果とメタデータを含む
4. Lambda 関数は EventBridge API エラーを適切に処理する
5. カスタムバスはデフォルトの EventBridge バスとは別である

### 要件 5: 複雑な依存関係を持つ CDK インフラ

**ユーザーストーリー:** 開発者として、複雑なインフラを CDK で定義したい。最も高度な IAM ポリシーシナリオをテストするため。

#### 受け入れ基準

1. CDK スタックは AWS CDK v2 を使用して TypeScript で実装される
2. CDK スタックは 2 つの別々の KMS キーリソースを作成する
3. CDK スタックは初期権限設定に grant メソッドを使用する
4. CDK スタックはサービス間依存関係を正しく設定する
5. CDK スタックは任意の AWS リージョンにデプロイ可能である
6. CDK スタックは KMS キーポリシーとリソースポリシーを処理する

### 要件 6: 包括的サービス統合

**ユーザーストーリー:** 開発者として、セキュリティ制御を持つ複数の AWS サービスを統合したい。複雑な権限マトリックスを処理する Autopilot の能力を評価するため。

#### 受け入れ基準

1. Lambda 関数は統合されたすべてのサービスの具体的な使用を実証する
2. サービス統合は AWS セキュリティベストプラクティスに従う
3. Lambda 関数はサービス固有のエラー条件を処理する
4. 統合は 3 つの環境の中で最も複雑な IAM ポリシーシナリオを作成する
5. Lambda 関数はエンドツーエンドの処理を正常に完了する

### 要件 7: 動作確認

**ユーザーストーリー:** 開発者として、CDK 生成の権限で正常に動作することを確認したい。最も複雑な権限要件での実装が正しく機能することを保証するため。

#### 受け入れ基準

1. 生成された IAM ポリシーは Bedrock、S3、KMS、Secrets Manager、EventBridge の権限を含む
2. ポリシーはサービス間権限依存関係を実証する
3. KMS 権限は S3 と Secrets Manager 操作を通じて暗黙的に要求される
4. Lambda 関数は CDK 生成の権限で正常に実行される
5. すべてのサービス操作が成功し、エンドツーエンドの処理が完了する

### 要件 8: プロジェクト構成とドキュメント

**ユーザーストーリー:** 開発者として、包括的なドキュメントと構成を持ちたい。複雑な検証環境を理解・保守するため。

#### 受け入れ基準

1. プロジェクトは他の環境とは別の明確なディレクトリ構造を持つ
2. プロジェクトはサービス相互作用の詳細なドキュメントを含む
3. プロジェクトは KMS キー管理とクリーンアップ手順を含む
4. プロジェクトはコスト考慮事項とクリーンアップ手順を含む
5. プロジェクトは複雑なサービス相互作用のトラブルシューティングガイドを含む

### 要件 9: コンストラクト分割アーキテクチャ

**ユーザーストーリー:** 開発者として、各コンポーネントを再利用可能なコンストラクトとして実装したい。他のプロジェクトでも同じコンポーネントを使用できるようにするため。

#### 受け入れ基準

1. WHEN KMS キーが必要な場合、THE KMS_Key_Construct SHALL 独立して動作し、設定可能な KMS キーを作成する
2. WHEN KMS 暗号化 S3 バケットが必要な場合、THE S3_Storage_Construct SHALL 指定された KMS キーで暗号化された S3 バケットを作成する
3. WHEN Secrets Manager が必要な場合、THE Secrets_Manager_Construct SHALL 指定された KMS キーで暗号化されたシークレットを作成する
4. WHEN EventBridge カスタムバスが必要な場合、THE EventBridge_Construct SHALL 独立して動作し、設定可能なカスタムバスを作成する
5. WHEN Lambda 関数が必要な場合、THE Lambda_Function_Construct SHALL 独立して動作し、複雑なサービス統合を持つ Lambda 関数を作成する
6. WHEN 複雑な IAM 権限設定が必要な場合、THE IAM_Permission_Construct SHALL 最小権限の原則に従って複数サービスと暗黙的 KMS 権限を付与する

### 要件 10: スタック軽量化

**ユーザーストーリー:** 開発者として、スタックを軽量に保ちたい。スタックはコンストラクトの組み合わせのみを行い、具体的なリソース設定は各コンストラクトに委譲するため。

#### 受け入れ基準

1. WHEN スタックを定義する場合、THE Stack SHALL 各コンストラクトのインスタンス化と接続のみを行う
2. WHEN スタックを定義する場合、THE Stack SHALL 具体的な AWS リソースの設定を含まない
3. THE Stack SHALL 複雑なコンストラクト間の依存関係を明確に管理する
4. THE Stack SHALL 必要な出力値を外部に公開する
