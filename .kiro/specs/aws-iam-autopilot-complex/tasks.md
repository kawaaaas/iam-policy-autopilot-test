# 実装計画: AWS IAM 検証環境（Complex）

## 概要

Lambda 関数が Bedrock、KMS 暗号化された S3、Secrets Manager、EventBridge を統合利用する最も複雑な AWS 環境を実装します。CDK v2 と TypeScript を使用し、複雑なサービス間依存関係と暗黙的な KMS 権限を含む高度な権限付与を行います。

## タスク

- [ ] 1. プロジェクト構造と CDK 初期設定

  - TypeScript CDK プロジェクトの初期化
  - 必要な依存関係の追加（AWS SDK v3、CDK v2、全サービス用）
  - プロジェクトディレクトリ構造の作成
  - _要件: 8.1, 8.3_

- [ ] 2. KMS キーと S3 バケットの作成

  - [ ] 2.1 S3 用 KMS キーの作成

    - CDK でカスタマーマネージド KMS キー作成
    - キーローテーション有効化
    - 適切なキーポリシー設定
    - _要件: 2.2, 5.2_

  - [ ] 2.2 KMS 暗号化 S3 バケットの作成

    - CDK で S3 バケットリソース定義
    - カスタマーマネージド KMS 暗号化設定
    - 検証用の removalPolicy 設定
    - _要件: 2.1, 2.3_

  - [ ]\* 2.3 プロパティテスト: KMS 暗号化の透明性（S3）
    - **プロパティ 2: KMS 暗号化の透明性**（S3 部分）
    - **検証対象: 要件 2.4, 2.5**

- [ ] 3. Secrets Manager と KMS 設定

  - [ ] 3.1 Secrets 用 KMS キーの作成

    - CDK で別のカスタマーマネージド KMS キー作成
    - S3 用とは独立したキー管理
    - _要件: 3.2, 5.2_

  - [ ] 3.2 暗号化された Secrets Manager の作成

    - CDK で Secrets Manager リソース定義
    - ダミー webhook URL の設定
    - カスタマーマネージド KMS 暗号化
    - _要件: 3.1, 3.2_

  - [ ]\* 3.3 プロパティテスト: シークレット取得の安全性
    - **プロパティ 3: シークレット取得の安全性**
    - **検証対象: 要件 3.3, 3.4**

- [ ] 4. EventBridge カスタムバスの作成

  - [ ] 4.1 CDK でカスタム EventBridge バス作成

    - カスタムイベントバスの定義
    - デフォルトバスとの分離確認
    - _要件: 4.1, 4.5_

  - [ ]\* 4.2 プロパティテスト: イベント送信の確実性
    - **プロパティ 4: イベント送信の確実性**
    - **検証対象: 要件 4.2, 4.3**

- [ ] 5. Lambda 関数の実装

  - [ ] 5.1 Bedrock 統合の実装

    - Node.js 22.x 用の Bedrock Runtime Client 実装
    - Claude 3 Sonnet モデルの呼び出し
    - テキスト処理とレスポンス解析
    - _要件: 1.1, 1.2, 1.3_

  - [ ] 5.2 Secrets Manager 統合の実装

    - AWS SDK v3 を使用した GetSecretValue 実装
    - KMS 復号化の透明な処理
    - webhook URL 取得と使用
    - _要件: 3.3, 3.4_

  - [ ] 5.3 S3 統合の実装

    - AWS SDK v3 を使用した S3 PutObject 実装
    - KMS 暗号化の透明な処理
    - 処理結果の構造化保存
    - _要件: 1.4, 2.4, 2.5_

  - [ ] 5.4 EventBridge 統合の実装

    - AWS SDK v3 を使用した PutEvents 実装
    - カスタムイベント形式の定義
    - 処理結果とメタデータの送信
    - _要件: 4.2, 4.3_

  - [ ]\* 5.5 プロパティテスト: エンドツーエンド処理の完全性

    - **プロパティ 1: エンドツーエンド処理の完全性**
    - **検証対象: 要件 1.4, 6.5**

  - [ ] 5.6 統合エラーハンドリングの実装

    - 各サービス固有のエラー処理
    - 部分実行時のロールバック処理
    - 包括的なログ出力
    - \_要件: 1.5, 6.3\*\*

  - [ ]\* 5.7 プロパティテスト: エラー時の部分実行防止
    - **プロパティ 6: エラー時の部分実行防止**
    - **検証対象: 要件 1.5, 6.3**

- [ ] 6. CDK スタックの統合

  - [ ] 6.1 Lambda 関数リソースの定義

    - CDK で Lambda 関数リソース作成
    - 全サービス用の環境変数設定
    - Node.js 22.x ランタイムとメモリ設定
    - _要件: 5.1, 5.4_

  - [ ] 6.2 複雑な IAM 権限の設定

    - Bedrock 権限の付与
    - S3 と KMS 権限の付与（s3.grantReadWrite）
    - Secrets Manager と KMS 権限の付与
    - EventBridge 権限の付与
    - _要件: 5.3, 5.6, 6.2_

  - [ ]\* 6.3 プロパティテスト: 権限マトリックスの最小化
    - **プロパティ 5: 権限マトリックスの最小化**
    - **検証対象: 要件 5.3, 7.1, 7.2**

- [ ] 7. チェックポイント - 複雑な統合確認

  - すべてのテストが通ることを確認し、質問があればユーザーに確認する

- [ ] 8. デプロイとテスト

  - [ ] 8.1 CDK スタックのデプロイ

    - cdk deploy コマンドで AWS にデプロイ
    - 全リソース作成と KMS キー確認
    - Bedrock モデルアクセス権限確認
    - _要件: 5.5_

  - [ ] 8.2 エンドツーエンド統合テスト

    - Lambda 関数の手動実行
    - 全サービス統合の動作確認
    - S3 保存データと EventBridge イベント確認
    - _要件: 6.5, 7.3, 7.4_

  - [ ]\* 8.3 複雑なエラーケーステスト
    - 各サービスのエラー条件テスト
    - KMS 権限エラーのテスト
    - 部分実行防止の確認
    - \_要件: 6.3, 7.2\*\*

- [ ] 9. ドキュメントとクリーンアップ

  - [ ] 9.1 包括的な README.md の作成

    - デプロイ手順と Bedrock アクセス設定
    - 各サービス統合の説明
    - KMS キー管理とコスト注意事項
    - _要件: 8.2, 8.4_

  - [ ] 9.2 クリーンアップとコスト管理
    - cdk destroy でリソース削除確認
    - KMS キー削除スケジュール確認
    - Bedrock コスト確認
    - _要件: 8.3, 8.4, 8.5_

## 注意事項

- `*`マークのタスクはオプションで、コア機能を優先して MVP を早く作成できます
- 各タスクは特定の要件への追跡可能性のため要件番号を参照しています
- チェックポイントで段階的な検証を行います
- プロパティテストは汎用的な正確性プロパティを検証します
- ユニットテストは特定の例とエッジケースを検証します
- KMS キーは月額$1 のコストが発生するため、検証後の削除を推奨します
- Bedrock は使用量に応じた課金のため、テスト時の使用量に注意してください
- 他の環境とは完全に独立したディレクトリ構造で実装します
